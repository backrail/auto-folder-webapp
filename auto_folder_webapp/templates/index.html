<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è‡ªå‹•ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆWebã‚¢ãƒ—ãƒª</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif; 
      margin: 0.5rem; /* bodyã®ä½™ç™½ã‚’å°ã•ã */
      line-height: 1.6; 
      font-size: 0.95rem; /* å…¨ä½“çš„ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¾®èª¿æ•´ */
    }
    .card { 
      max-width: 1280px; 
      margin: 0 auto; 
      border: 1px solid #ddd; 
      border-radius: 14px; 
      padding: 0.8rem; /* ã‚«ãƒ¼ãƒ‰ã®ä½™ç™½ã‚’å°ã•ã */
      box-shadow: 0 2px 10px rgba(0,0,0,0.06); 
    }
    h1 { 
      font-size: 1.2rem; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’å°ã•ã */
      margin: 0; 
    }
    fieldset { 
      border: 1px solid #eee; 
      border-radius: 10px; 
      padding: 0.6rem; /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚»ãƒƒãƒˆã®ä½™ç™½ã‚’å°ã•ã */
      margin-bottom: 0.6rem; 
    }
    legend { 
      padding: 0 .5rem; 
      color: #444; 
    }
    label { 
      display: block; 
      font-size: .8rem; /* ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
      color: #333; 
      margin: .3rem 0 .2rem; 
    }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%; 
      padding: .4rem .5rem; /* å…¥åŠ›æ¬„ã®ä½™ç™½ã‚’å°ã•ã */
      border: 1px solid #ccc; 
      border-radius: 10px; 
      box-sizing: border-box;
      font-size: 0.9rem; /* å…¥åŠ›æ¬„ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
    }
    textarea { 
      min-height: 70px; /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’ä½ã */
    }
    .row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 0.6rem; /* è¡Œé–“ã®éš™é–“ã‚’ç‹­ã */
    }
    .row3 { 
      display: grid; 
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 0.6rem; 
    }
    .hint { 
      color: #666; 
      font-size: .75rem; /* ãƒ’ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
    }
    button { 
      padding: .5rem 1rem; /* ãƒœã‚¿ãƒ³ã®ä½™ç™½ã‚’å°ã•ã */
      border: none; 
      border-radius: 999px; 
      background: black; 
      color: white; 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 0.9rem;
    }
    .note { 
      background:#fff8e5; 
      border:1px solid #ffe08a; 
      padding:.5rem .7rem; /* ãƒãƒ¼ãƒˆã®ä½™ç™½ã‚’å°ã•ã */
      border-radius:10px; 
      font-size:.8rem; /* ãƒãƒ¼ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
    }
    .tabs { 
      display:flex; 
      gap:.3rem; 
      margin:.5rem 0 0.8rem; /* ã‚¿ãƒ–ã®ä½™ç™½ã‚’èª¿æ•´ */
    }
    .tabbtn { 
      padding:.4rem .8rem; /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ä½™ç™½ã‚’å°ã•ã */
      border:1px solid #ddd; 
      background:#f7f7f7; 
      border-radius:999px; 
      cursor:pointer; 
      font-size: 0.85rem;
    }
    .tabbtn.active { 
      background:black; 
      color:#fff; 
      border-color:black; 
    }
    .hidden { 
      display:none; 
    }
    .toggle-row { 
      display:flex; 
      align-items:center; 
      gap:.4rem; /* ãƒˆã‚°ãƒ«è¡Œã®éš™é–“ã‚’ç‹­ã */
      margin:.4rem 0; 
    }
    .disabled-area { 
      opacity: .6; 
    }
    /* Builder */
    .builder { 
      display:flex; 
      align-items:center; 
      gap:.4rem; 
      flex-wrap:wrap; 
    }
    .chip { 
      display:flex; 
      align-items:center; 
      gap:.3rem; 
      padding:.35rem .6rem; /* ãƒãƒƒãƒ—ã®ä½™ç™½ã‚’å°ã•ã */
      border:1px solid #ddd; 
      border-radius:999px; 
      background:#fafafa; 
      cursor:grab; 
      user-select:none; 
    }
    .chip:active { 
      cursor:grabbing; 
    }
    .chip[data-type="N"]{ 
      background:#eef6ff; 
      border-color:#cfe6ff; 
    }
    .chip .handle { 
      font-size:1rem; 
      opacity:.6; 
    }
    .ghost { 
      opacity:.4; 
    }
    .dropzone { 
      min-height: 34px; 
      display:flex; 
      gap:.3rem; 
      flex-wrap:wrap; 
      padding:.3rem; /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ä½™ç™½ã‚’å°ã•ã */
      border:1px dashed #ddd; 
      border-radius:10px; 
      background:#fcfcfc; 
    }
    /* Layout grid for widescreen */
    .grid2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 0.6rem; /* ã‚°ãƒªãƒƒãƒ‰ã®éš™é–“ã‚’ç‹­ã */
    }
    @media (max-width: 1100px){ 
      .grid2 { 
        grid-template-columns: 1fr; 
      } 
    }
    #previewWrap pre { 
      max-height: 25vh; /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é«˜ã•ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§èª¿æ•´ */
      font-size: 0.85rem;
    }
    .header-content { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 0.6rem; 
    }
    .header-content h1 { 
      margin: 0; 
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header-content">
      <h1>è‡ªå‹•ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ Webã‚¢ãƒ—ãƒª</h1>
      <form method="post" action="/generate" id="topForm">
        <button type="submit">ZIPã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </form>
    </div>
    
    <p class="note">æŒ‡å®šã—ãŸãƒ«ãƒ¼ãƒ«ã§å¤§é‡ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã¾ã¨ã‚ã¦ä½œæˆã—ã€ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚<br>ã€Œé€£ç•ªã€ã‚¿ãƒ–ã‹ã€Œã‚«ã‚¹ã‚¿ãƒ åã€ã‚¿ãƒ–ã®ã©ã¡ã‚‰ã‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
          {% for m in messages %}<li>{{ m }}</li>{% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="post" action="/generate" id="mainForm">
      <input type="hidden" name="mode" id="mode" value="auto">
      <input type="hidden" name="order" id="order" value="A,N,B">

      <div class="grid2">
        <fieldset>
          <legend>ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ«ãƒ€å</legend>
          <div class="tabs">
            <div id="tab-auto" class="tabbtn active" onclick="switchTab('auto')">é€£ç•ªã§ä½œæˆ</div>
            <div id="tab-custom" class="tabbtn" onclick="switchTab('custom')">ã‚«ã‚¹ã‚¿ãƒ åã§ä½œæˆ</div>
          </div>
          <div id="auto_block">
            <label>åå‰ãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆãƒ†ã‚­ã‚¹ãƒˆA/Bã‚’ç©ºã«ã™ã‚‹ã¨ãã®ãƒ–ãƒ­ãƒƒã‚¯ã¯éè¡¨ç¤ºã€‚ãƒ‰ãƒ©ãƒƒã‚°ã§é †åºå¤‰æ›´ï¼‰</label>
            <div id="builder" class="dropzone"></div>
            <div class="row">
              <div>
                <label>ãƒ†ã‚­ã‚¹ãƒˆA</label>
                <input type="text" name="textA" placeholder="ä¾‹: R06-">
              </div>
              <div>
                <label>ãƒ†ã‚­ã‚¹ãƒˆB</label>
                <input type="text" name="textB" placeholder="ä¾‹: -A">
              </div>
            </div>
            <div class="row">
              <div>
                <label>é€£ç•ªã®é–‹å§‹ç•ªå·</label>
                <input type="number" name="start" value="1" min="0">
              </div>
              <div>
                <label>é€£ç•ªã®æ¡æ•°ï¼ˆæ•°å­—ã‚¹ã‚¿ã‚¤ãƒ«æ™‚ï¼‰</label>
                <input type="number" name="digits" value="4" min="1" max="10">
                <div class="hint">â€»é–‹å§‹ç•ªå·ãŒ3æ¡ä»¥ä¸Šãªã‚‰è‡ªå‹•ã§æ¡æ•°ã‚‚å¼•ãä¸Šã’ã¾ã™</div>
              </div>
            </div>
            <div class="row">
              <div>
                <label>ç•ªå·ã®å½¢å¼</label>
                <select name="num_style" id="num_style">
                  <option value="num">æ•°å­—ï¼ˆ1,2,3...ï¼‰</option>
                  <option value="alpha">è‹±å­—ï¼ˆA,B,C...ï¼‰</option>
                  <option value="iroha">ã„ã‚ã¯ï¼ˆã‚¤,ãƒ­,ãƒ...ï¼‰</option>
                </select>
                <div class="toggle-row">
                  <input type="checkbox" id="use_paren" name="use_paren">
                  <label for="use_paren">ç•ªå·ã‚’æ‹¬å¼§ï¼ˆ ï¼‰ã§å›²ã‚€</label>
                </div>
              </div>
              <div>
                <label>ä½œæˆæ•°</label>
                <input type="number" name="count" value="10" min="1" max="10000">
              </div>
            </div>
          </div>
          <div id="custom_block" class="hidden">
            <label>ã‚«ã‚¹ã‚¿ãƒ åï¼ˆ1è¡Œï¼1ãƒ•ã‚©ãƒ«ãƒ€åï¼‰</label>
            <textarea name="custom_names" placeholder="R06-çµŒç†
R06-ç·å‹™
R06-å–¶æ¥­"></textarea>
            <div class="hint">â€»ç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚</div>
          </div>
        </fieldset>

        <fieldset>
          <legend>å­ï¼å­«ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆä»»æ„ï¼‰</legend>
          <div class="toggle-row">
            <input type="checkbox" id="child_enabled" name="child_enabled" onchange="toggleArea('child')">
            <label for="child_enabled">å­ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹</label>
          </div>
          <div id="child_area" class="disabled-area">
            <label>å­ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆã‚«ãƒ³ãƒ or æ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
            <textarea name="child_names" placeholder="01_æ›¸é¡, 02_è¨¼æ†‘, 99_ä¸€æ™‚" disabled></textarea>
          </div>
          <div class="toggle-row" style="margin-top:.6rem">
            <input type="checkbox" id="grand_enabled" name="grand_enabled" onchange="toggleArea('grand')">
            <label for="grand_enabled">å­«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹</label>
          </div>
          <div id="grand_area" class="disabled-area">
            <label>å­«ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆã‚«ãƒ³ãƒ or æ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
            <textarea name="grand_names" placeholder="A_æœªå‡¦ç†, B_ç¢ºèªä¸­, C_å®Œäº†" disabled></textarea>
          </div>
          <div class="hint">â€»å­ãƒ»å­«ã¯å„ãƒˆãƒƒãƒ—ãƒ•ã‚©ãƒ«ãƒ€ã®ç›´ä¸‹ã«åŒã˜æ§‹æˆã§ä½œæˆã•ã‚Œã¾ã™ã€‚</div>
        </fieldset>
      </div>

      <div>
        <fieldset>
          <legend>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</legend>
          <div id="previewWrap" class="preview">
            <pre id="preview" style="background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px;overflow:auto;max-height:25vh;white-space:pre;"></pre>
            <div class="hint" id="previewHint"></div>
          </div>
        </fieldset>
      </div>
    </form>
  </div>

<script>
function switchTab(which){
  const autoBtn = document.getElementById('tab-auto');
  const customBtn = document.getElementById('tab-custom');
  const autoBlock = document.getElementById('auto_block');
  const customBlock = document.getElementById('custom_block');
  const mode = document.getElementById('mode');

  if(which === 'auto'){
    autoBtn.classList.add('active'); customBtn.classList.remove('active');
    autoBlock.classList.remove('hidden'); customBlock.classList.add('hidden');
    mode.value = 'auto';
  }else{
    customBtn.classList.add('active'); autoBtn.classList.remove('active');
    customBlock.classList.remove('hidden'); customBlock.classList.add('hidden');
    mode.value = 'custom';
  }
  computePreview();
}

function toggleArea(kind){
  const enabled = document.getElementById(kind + '_enabled').checked;
  const area = document.getElementById(kind + '_area');
  const ta = area.querySelector('textarea');
  ta.disabled = !enabled;
  area.classList.toggle('disabled-area', !enabled);
  computePreview();
}

/* --- Builder: dynamic chips (show only filled fields) + DnD --- */
function renderChips(){
  const builder = document.getElementById('builder');
  const textA = document.querySelector('[name=textA]').value || '';
  const textB = document.querySelector('[name=textB]').value || '';
  let order = (document.getElementById('order').value || 'A,N,B').split(',').filter(Boolean);

  // Ensure N present
  if(!order.includes('N')) order.unshift('N');

  // Filter out empty A/B
  order = order.filter(tok => (tok==='A' ? !!textA : (tok==='B' ? !!textB : true)));

  // If user typed into empty field, append corresponding token at end
  if(textA && !order.includes('A')) order.push('A');
  if(textB && !order.includes('B')) order.push('B');

  // Render
  builder.innerHTML = '';
  const mapLabel = {A:'ãƒ†ã‚­ã‚¹ãƒˆA', N:'ç•ªå·', B:'ãƒ†ã‚­ã‚¹ãƒˆB'};
  order.forEach(tok => {
    const div = document.createElement('div');
    div.className = 'chip';
    div.draggable = true;
    div.dataset.type = tok;
    div.innerHTML = '<span class="handle">â ¿</span><b>' + mapLabel[tok] + '</b>';
    builder.appendChild(div);
  });

  document.getElementById('order').value = order.join(',');
  setupDnD();
}

function serializeOrder(){
  const chips = Array.from(document.querySelectorAll('#builder .chip'));
  const order = chips.map(c => c.dataset.type).join(',');
  document.getElementById('order').value = order;
  return order;
}
function setupDnD(){
  const container = document.getElementById('builder');
  let dragEl = null;
  container.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('dragstart', (e)=>{
      dragEl = ch;
      ch.classList.add('ghost');
      e.dataTransfer.effectAllowed = 'move';
    });
    ch.addEventListener('dragend', ()=>{
      ch.classList.remove('ghost');
      dragEl = null;
      serializeOrder();
      computePreview();
    });
  });
  container.addEventListener('dragover', (e)=>{
    e.preventDefault();
    const after = getDragAfterElement(container, e.clientX);
    if(dragEl){
      if(after == null){
        container.appendChild(dragEl);
      } else {
        container.insertBefore(dragEl, after);
      }
    }
  });
  function getDragAfterElement(container, x){
    const els = [...container.querySelectorAll('.chip:not(.ghost)')];
    return els.reduce((closest, child)=>{
      const rect = child.getBoundingClientRect();
      const offset = x - rect.left - rect.width/2;
      if(offset < 0 && offset > closest.offset){
        return { offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
}

/* --- Live Preview & helpers --- */
const mainForm = document.getElementById('mainForm');
const topForm = document.getElementById('topForm');
const preview = document.getElementById('preview');
const previewHint = document.getElementById('previewHint');

function parseList(text){
  if(!text) return [];
  return text.replace(/,/g, "\n").split(/\n/).map(s=>s.trim()).filter(Boolean);
}
function zfill(num, digits){
  const s = String(num);
  return s.length >= digits ? s : "0".repeat(digits - s.length) + s;
}
function alphaCol(n){
  let n0 = Math.max(1, n);
  let s = "";
  while(n0 > 0){
    const rem = (n0 - 1) % 26;
    s = String.fromCharCode(65 + rem) + s;
    n0 = Math.floor((n0 - 1) / 26);
  }
  return s;
}
const IROHA = ["ã‚¤","ãƒ­","ãƒ","ãƒ‹","ãƒ›","ãƒ˜","ãƒˆ","ãƒ","ãƒª","ãƒŒ","ãƒ«","ãƒ²","ãƒ¯","ã‚«","ãƒ¨","ã‚¿","ãƒ¬","ã‚½","ãƒ„","ãƒ","ãƒŠ","ãƒ©","ãƒ ","ã‚¦","ãƒ°","ãƒ","ã‚ª","ã‚¯","ãƒ¤","ãƒ","ã‚±","ãƒ•","ã‚³","ã‚¨","ãƒ†","ã‚¢","ã‚µ","ã‚­","ãƒ¦","ãƒ¡","ãƒŸ","ã‚·","ãƒ±","ãƒ’","ãƒ¢","ã‚»","ã‚¹"];
function irohaN(n){
  const idx = (n - 1) % IROHA.length;
  return IROHA[idx];
}
function formatToken(nRaw, style, digits, useParen){
  let token;
  if(style === 'num'){
    token = zfill(nRaw, digits);
  } else if(style === 'alpha'){
    token = alphaCol(nRaw);
  } else if(style === 'iroha'){
    token = irohaN(nRaw);
  } else {
    token = String(nRaw);
  }
  if(useParen){ token = '(' + token + ')'; }
  return token;
}
function makeTopNames(){
  const mode = document.getElementById('mode').value;
  if(mode === 'custom'){
    return parseList(document.querySelector('[name=custom_names]').value);
  } else {
    const order = serializeOrder().split(',').filter(Boolean);
    const textA = document.querySelector('[name=textA]').value || '';
    const textB = document.querySelector('[name=textB]').value || '';
    const start = parseInt(document.querySelector('[name=start]').value || '1', 10);
    const digitsEl = document.querySelector('[name=digits]');
    const digits = parseInt(digitsEl.value || '1', 10);
    const count = Math.max(0, parseInt(document.querySelector('[name=count]').value || '0', 10));
    const style = document.getElementById('num_style').value;
    const useParen = document.getElementById('use_paren').checked;

    if(style === 'num'){
      const need = Math.max(3, String(start).length);
      if(digits < need){ digitsEl.value = need; }
    }

    const tops = [];
    for(let i=0;i<count;i++){
      const token = formatToken(start + i, style, parseInt(digitsEl.value,10), useParen);
      const parts = order.map(tok => tok==='A'? textA : (tok==='B'? textB : token));
      tops.push(parts.join(''));
    }
    return tops;
  }
}
function computePreview(){
  renderChips();
  const tops = makeTopNames();
  const childOn = document.getElementById('child_enabled').checked;
  const grandOn = document.getElementById('grand_enabled').checked;
  const children = childOn ? parseList(document.querySelector('[name=child_names]').value) : [];
  const grands = grandOn ? parseList(document.querySelector('[name=grand_names]').value) : [];

  const MAX_TOP = 5;
  const lines = [];
  const showCount = Math.min(MAX_TOP, tops.length || 0);
  for(let ti=0; ti<showCount; ti++){
    const top = tops[ti];
    lines.push(`ğŸ“ ${top}/`);
    if(children.length){
      for(const c of children){
        lines.push(`  ğŸ“ ${c}/`);
        if(grands.length){
          for(const g of grands){
            lines.push(`    ğŸ“ ${g}/`);
          }
        }
      }
    } else if(grands.length){
      for(const g of grands){
        lines.push(`  ğŸ“ ${g}/`);
      }
    }
  }
  if((tops.length || 0) > MAX_TOP){
    lines.push(`â€¦ ã»ã‹ ${tops.length - MAX_TOP} ãƒ•ã‚©ãƒ«ãƒ€`);
  }
  preview.textContent = lines.length ? lines.join("\n") : "ï¼ˆã“ã“ã«ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰";
  if(tops.length){
    previewHint.textContent = `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å…ˆé ­ ${showCount} ä»¶ã¾ã§è¡¨ç¤ºï¼ˆåˆè¨ˆ ${tops.length} ãƒ•ã‚©ãƒ«ãƒ€ï¼‰`;
  }else{
    previewHint.textContent = "";
  }
}
function wirePreview(){
  mainForm.addEventListener('input', computePreview);
  topForm.addEventListener('submit', function(e) {
    e.preventDefault();
    mainForm.submit();
  });
  document.getElementById('order').value = 'A,N,B';
  renderChips();
  computePreview();
}
document.addEventListener('DOMContentLoaded', wirePreview);
</script>
</body>
</html>